ğŸ‘‰ **ä¸æ¨ç¿»ã€ä¸é‡å¯«ã€ä¸å“²å­¸åŒ–**
ğŸ‘‰ åªåšã€Œé‚Šç•Œæ‹‰ç›´ã€è²¬ä»»æ­¸ä½ã€å‘½åèªªå¯¦è©±ã€

---

# ä¸€ã€å…ˆçµ¦ä½ ä¸€å¥ç¸½è¨ºæ–·ï¼ˆå¾ˆé‡è¦ï¼‰

> **ä½ ç¾åœ¨å…¶å¯¦å·²ç¶“åœ¨åš DDD / Clean Architectureï¼Œä½†è¢«ã€ŒæŠ€è¡“è³‡æ–™å¤¾ã€å’Œã€Œæ­·å²æ¼”é€²ã€æ©è“‹äº†çœŸæ­£çš„çµæ§‹ã€‚**

å…·é«”ç—‡ç‹€ï¼š

| ç—‡ç‹€                            | è¡¨ç¾                            |
| ----------------------------- | ----------------------------- |
| API / Service / Repository æ··ç”¨ | åŒä¸€å€‹æ¦‚å¿µåœ¨ 3 å€‹åœ°æ–¹å‡ºç¾                |
| infrastructure éèƒ–             | bot / redis / mexc / tasks å…¨å¡ |
| domain åå¼±                     | æ ¸å¿ƒè¦å‰‡è¢« services æ¶èµ°             |
| utils æ°¾æ¿«                      | æˆç‚ºé€ƒé¿è¨­è¨ˆçš„åƒåœ¾æ¡¶                    |

---


ğŸ‘‰ **ä¸æ¨ç¿»ã€ä¸é‡å¯«ã€ä¸å“²å­¸åŒ–**
ğŸ‘‰ åªåšã€Œé‚Šç•Œæ‹‰ç›´ã€è²¬ä»»æ­¸ä½ã€å‘½åèªªå¯¦è©±ã€

---

# ä¸€ã€ç¸½è¨ºæ–·ï¼ˆç²¾ç°¡ï¼‰

**ä½ ç¾åœ¨å…¶å¯¦å·²ç¶“åœ¨åš DDD / Clean Architectureï¼Œä½†è¢«ã€ŒæŠ€è¡“è³‡æ–™å¤¾ã€å’Œã€Œæ­·å²æ¼”é€²ã€æ©è“‹äº†çœŸæ­£çš„çµæ§‹ã€‚**

å¸¸è¦‹ç—‡ç‹€ï¼š

| ç—‡ç‹€ | è¡¨ç¾ |
| --- | --- |
| API / Service / Repository æ··ç”¨ | åŒä¸€å€‹æ¦‚å¿µå‡ºç¾åœ¨å¤šè™• |
| infrastructure éèƒ– | bot / redis / mexc / tasks äº’ç›¸æ··é›œ |
| domain åå¼± | æ ¸å¿ƒè¦å‰‡è¢« services æ¶èµ° |
| utils æ°¾æ¿« | æˆç‚ºé€ƒé¿è¨­è¨ˆçš„åƒåœ¾æ¡¶ |

---

# äºŒã€ç›®æ¨™çµæ§‹è—åœ–ï¼ˆç²¾ç°¡ç‰ˆï¼‰

é€™æ˜¯ Trading Platform / Bot System çš„ç©©å®šå½¢ç‹€ï¼Œä½œç‚ºé‡æ§‹ç›®æ¨™ï¼š

```text
src/
â””â”€â”€ app/
    â”œâ”€â”€ interfaces/      # HTTP / tasks / UIï¼ˆä¸å«æ¥­å‹™ï¼‰
    â”œâ”€â”€ application/     # ç”¨ä¾‹ï¼ˆ1 æª” = 1 ç”¨ä¾‹ï¼‰
    â”œâ”€â”€ domain/          # è¦å‰‡ã€ç­–ç•¥ã€é¢¨æ§ã€ports
    â”œâ”€â”€ infrastructure/  # æŠ€è¡“å¯¦ä½œï¼šexchange / redis / bot_runtime / scheduler
    â”œâ”€â”€ shared/          # æ¥µå°å…±ç”¨å·¥å…·ï¼ˆids/time/typingï¼‰
    â””â”€â”€ bootstrap.py     # å”¯ä¸€çµ„è£é»
```

---

# ä¸‰ã€é€å€åŸŸå°æ‡‰ï¼ˆç¾åœ¨ â†’ æœªä¾†ï¼‰

1) `api/` â†’ `interfaces/http/`
- æ§åˆ¶å™¨ï¼ˆrequest â†’ usecaseï¼‰ï¼Œ**ä¸å«å•†æ¥­é‚è¼¯**ï¼Œä¸ import infrastructureã€‚

2) `services/` + `repositories/` â†’ `application/`
- ç”¨ä¾‹å±¤ï¼šæ¯å€‹ç”¨ä¾‹ä¸€æª”ï¼Œä¾è³´ portsï¼ˆrepository ç‚ºä¾è³´ï¼Œä¸æ˜¯ä¸»è§’ï¼‰ã€‚

3) `domain/interfaces` â†’ `domain/ports`
- domain åªèªèƒ½åŠ›ï¼ˆportï¼‰ï¼Œinfrastructure å¯¦ä½œ portã€‚

4) `infrastructure/external/mexc_client` â†’ `infrastructure/exchange/mexc/`ï¼ˆå”å®šå±¤æ‹†åˆ†ï¼‰
- åªåšå°æ¥ï¼Œä¸æ”¾ç­–ç•¥æˆ–æ¥­å‹™æ±ºç­–ã€‚

5) `infrastructure/bot` â†’ `infrastructure/bot_runtime`
- bot = runtime engineï¼ˆlifecycle / executor / collector / risk bridgeï¼‰ã€‚

6) `utils/` â†’ `shared/`ï¼ˆåªç•™çœŸæ­£å¯å…±äº«çš„å°å·¥å…·ï¼štime/ids/typingï¼‰

---

# å››ã€æ ¸å¿ƒæ‹†åˆ†åŸå‰‡ï¼ˆç°¡æ˜ï¼‰

- ä¸€å€‹æª”æ¡ˆåªå›ç­”ä¸€å€‹å•é¡Œï¼ˆ1 æª” = 1 ç”¨ä¾‹ / 1 port / 1 å”å®šï¼‰
- æµç¨‹ï¼ˆapplicationï¼‰ â‰  è¦å‰‡ï¼ˆdomainï¼‰ â‰  IOï¼ˆinfrastructureï¼‰
- `__init__.py` åªåš re-exportï¼Œé¿å…éš±å½¢è‚¥å¤§

---

# äº”ã€æ–‡ä»¶åŒ–èˆ‡é˜²è…æªæ–½ï¼ˆé‡è¦ï¼‰

èªçŸ¥è¦å‰‡ï¼ˆåªè¨˜äº”æ¢ï¼‰ï¼š
1. HTTP ä¸å¾— import infrastructure
2. domain ä¸çŸ¥é“ Redis / MEXC
3. application æ‰èƒ½èª¿ç”¨ port
4. infrastructure åªèƒ½å¯¦ä½œ port
5. bootstrap æ˜¯å”¯ä¸€é»åˆé»

å¯¦æˆ°å»ºè­°ï¼š
- å¯«å€‹æª¢æŸ¥å™¨ï¼š
  ```bash
  find src -name "*.py" -size +4k
  ```
- PR è¦å‰‡ï¼šè¶…é 4000 bytes ä¸å‡† mergeã€‚é‡åˆ°å¤§æª”å…ˆæ‹†ç”¨ä¾‹æˆ–æ‹† domain è¦å‰‡ã€‚

---

# å…­ã€é‡å° MEXC / Redis çš„çµ‚æ¥µæ‹†åˆ†ï¼ˆä¿è­‰ä¸çˆ†æª”ï¼‰

åŸå‰‡ï¼šä¸€å€‹æª”æ¡ˆ = ä¸€å€‹å”å®šé¢å‘ Ã— ä¸€å€‹è²¬ä»»ã€‚

MEXCï¼ˆå”å®šç´šæ‹†åˆ†ï¼‰å»ºè­°çµæ§‹ï¼š
```
infrastructure/exchange/mexc/
â”œâ”€â”€ http/      # å„ endpoint å–®æª”ï¼šmarket/get_price.py, account/get_balance.py, trade/place_order.py
â”œâ”€â”€ ws/        # ws connect / subscribe / handlers
â”œâ”€â”€ adapters/  # thin adapters å¯¦ä½œ domain ports
â””â”€â”€ _shared/   # http_client, parser, errors
```

Redisï¼ˆè²¬ä»»åˆ†æ˜ï¼‰å»ºè­°çµæ§‹ï¼š
```
infrastructure/persistence/redis/
â”œâ”€â”€ connection/
â”œâ”€â”€ codecs/
â”œâ”€â”€ keys/
â””â”€â”€ repos/     # æ¯ç¨® key pattern ä¸€å€‹ repo
```

ç‚ºä»€éº¼ï¼šå”å®šèˆ‡ç”¨é€”åˆ†æª” â†’ æ¯å€‹æª”æ¡ˆéƒ½å°ã€å¯æ¸¬è©¦ã€å¯æ›¿æ›ã€‚

ç¡¬æ€§æ–‡ä»¶è¦å‰‡ï¼ˆå»ºè­°åŠ å…¥ `ARCHITECTURE_RULES.md`ï¼‰ï¼š
```
- Any .py file MUST be <= 4000 bytes
- MEXC / Redis MUST follow protocol-level split
- "client.py", "core.py", "utils.py"ï¼ˆæ³›ç”¨è‚¥æª”ï¼‰æ‡‰é¿å…
- Adapters MUST be thin (< 500 lines)
```

---

# ä¸ƒã€ä¸‹ä¸€æ­¥ï¼ˆæˆ‘å¯ä»¥å¹«ä½ è½åœ°ï¼‰

æˆ‘å¯ä»¥æ›¿ä½ å®Œæˆå…¶ä¸­ä»»ä¸€é …ï¼š
- `application/trading/execute_trade.py`ï¼ˆç¯„ä¾‹ç”¨ä¾‹ï¼‰
- `domain/ports` æ¨™æº– interface å¯«æ³•
- `infrastructure/exchange/mexc/http/market/get_price.py`ï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰
- `ARCHITECTURE_RULES.md`ï¼ˆåŒ…å« 4000 bytes æ¢æ¬¾èˆ‡æª¢æŸ¥è…³æœ¬ï¼‰

å¦‚æœè¦æˆ‘ç›´æ¥å‹•æ‰‹ï¼Œè«‹å‘Šè¨´æˆ‘æƒ³å…ˆè½åœ°å“ªä¸€é …ï¼Œæˆ‘æœƒæŠŠå°æ‡‰æª”æ¡ˆèˆ‡æ¸¬è©¦ç¯„ä¾‹ä¸€ä½µç”¢å‡ºã€‚

# ğŸ¯ çµ‚æ¥µåŸå‰‡ï¼ˆåªå° mexc / redis å•Ÿç”¨ï¼‰

> **ä¸€å€‹æª”æ¡ˆ = ä¸€å€‹å”å®šé¢å‘ Ã— ä¸€å€‹è²¬ä»»**

ä¸èƒ½å†ç”¨ã€Œclient.py / repo.pyã€é€™ç¨®è‚¥æª”ã€‚

---

## ä¸€ã€MEXC â€”â€”ã€Œä¸€å€‹ endpoint / channel ä¸€å€‹æª”æ¡ˆã€

### âŒ çµ•å°ä¸èƒ½å†å‡ºç¾

* `client.py`
* `core.py`
* `market_repo.py`
* `ws_client.py`

é€™äº›**ä¸€å®šçˆ†**ã€‚

---

## âœ… MEXC æœ€å°å¯ç¶­è­·çµæ§‹ï¼ˆä¿è­‰ä¸çˆ†ï¼‰

```text
infrastructure/
â””â”€â”€ exchange/
    â””â”€â”€ mexc/
        â”œâ”€â”€ http/
        â”‚   â”œâ”€â”€ auth/
        â”‚   â”‚   â”œâ”€â”€ sign_request.py
        â”‚   â”‚   â””â”€â”€ headers.py
        â”‚   â”‚
        â”‚   â”œâ”€â”€ market/
        â”‚   â”‚   â”œâ”€â”€ get_price.py
        â”‚   â”‚   â”œâ”€â”€ get_orderbook.py
        â”‚   â”‚   â”œâ”€â”€ get_klines.py
        â”‚   â”‚   â””â”€â”€ get_trades.py
        â”‚   â”‚
        â”‚   â”œâ”€â”€ account/
        â”‚   â”‚   â”œâ”€â”€ get_balance.py
        â”‚   â”‚   â”œâ”€â”€ list_orders.py
        â”‚   â”‚   â””â”€â”€ list_trades.py
        â”‚   â”‚
        â”‚   â”œâ”€â”€ trade/
        â”‚   â”‚   â”œâ”€â”€ place_order.py
        â”‚   â”‚   â””â”€â”€ cancel_order.py
        â”‚   â”‚
        â”‚   â””â”€â”€ _shared/
        â”‚       â”œâ”€â”€ http_client.py
        â”‚       â”œâ”€â”€ response_parser.py
        â”‚       â””â”€â”€ errors.py
        â”‚
        â”œâ”€â”€ ws/
        â”‚   â”œâ”€â”€ connect.py
        â”‚   â”œâ”€â”€ subscribe_market.py
        â”‚   â”œâ”€â”€ subscribe_account.py
        â”‚   â”œâ”€â”€ handlers.py
        â”‚   â””â”€â”€ message_types.py
        â”‚
        â”œâ”€â”€ adapters/
        â”‚   â”œâ”€â”€ market_adapter.py
        â”‚   â”œâ”€â”€ trade_adapter.py
        â”‚   â””â”€â”€ account_adapter.py
        â”‚
        â””â”€â”€ __init__.py
```

### ğŸ”’ ç‚ºä»€éº¼ä¸€å®šä¸æœƒçˆ†ï¼Ÿ

* `get_price.py` â‰ˆ 100â€“200 è¡Œ
* `place_order.py` ä¸å¯èƒ½è·Ÿ WS æ··
* auth / parser ç¨ç«‹
* adapter åªåšã€Œport â†’ endpoint çµ„åˆã€

---

## äºŒã€Redis â€”â€”ã€Œä¸€å€‹è³‡æ–™å‹æ…‹ Ã— ä¸€å€‹ç”¨é€”ã€

### âŒ çµ•å°ä¸èƒ½

* `redis_client.py`
* `helpers.py`
* `*_core.py`

é€™æ˜¯è‚¥èƒ–æº«åºŠã€‚

---

## âœ… Redis æœ€å®‰å…¨çµæ§‹

```text
infrastructure/
â””â”€â”€ persistence/
    â””â”€â”€ redis/
        â”œâ”€â”€ connection/
        â”‚   â”œâ”€â”€ pool.py
        â”‚   â””â”€â”€ connect.py
        â”‚
        â”œâ”€â”€ codecs/
        â”‚   â”œâ”€â”€ json_codec.py
        â”‚   â”œâ”€â”€ msgpack_codec.py
        â”‚   â””â”€â”€ base.py
        â”‚
        â”œâ”€â”€ keys/
        â”‚   â”œâ”€â”€ account_keys.py
        â”‚   â”œâ”€â”€ market_keys.py
        â”‚   â””â”€â”€ trade_keys.py
        â”‚
        â”œâ”€â”€ repos/
        â”‚   â”œâ”€â”€ account_balance_repo.py
        â”‚   â”œâ”€â”€ market_price_repo.py
        â”‚   â”œâ”€â”€ trade_history_repo.py
        â”‚   â””â”€â”€ position_repo.py
        â”‚
        â”œâ”€â”€ locks/
        â”‚   â”œâ”€â”€ distributed_lock.py
        â”‚   â””â”€â”€ ttl_lock.py
        â”‚
        â””â”€â”€ errors.py
```

### ğŸ”’ ç‚ºä»€éº¼ Redis ä¹Ÿå£“å¾—ä½ï¼Ÿ

* ä¸€å€‹ repo åªè™•ç†ä¸€ç¨® key pattern
* codec / key / repo å®Œå…¨åˆ†é›¢
* æ²’æœ‰é€šç”¨ helper

---

## ä¸‰ã€é—œéµè¨­è¨ˆï¼š**Adapter æ˜¯ä½ çš„é˜²çˆ†é–¥**

```text
mexc/http/*  -> å”å®šç´°ç¯€
mexc/ws/*    -> å”å®šç´°ç¯€
mexc/adapters/* -> å¯¦ä½œ domain portï¼ˆæ¥µè–„ï¼‰
```

ğŸ‘‰ **domain æ°¸é çœ‹ä¸åˆ°å”å®šç´°ç¯€**
ğŸ‘‰ **å”å®šçˆ†äº†ä¹Ÿä¸æœƒæ±¡æŸ“å…¶ä»–åœ°æ–¹**

---

## å››ã€ç¡¬æ€§è¦å‰‡ï¼ˆæˆ‘å»ºè­°ä½ å¯«é€²æ–‡ä»¶ï¼‰

```md
## File Size Rule

- Any .py file MUST be <= 4000 bytes
- MEXC / Redis MUST follow protocol-level split
- "client.py", "core.py", "utils.py" are forbidden
- Adapters MUST be thin (< 500 lines)
```

---

## äº”ã€ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¹«ä½ ã€Œè½åœ°ã€

æˆ‘å¯ä»¥ **ç›´æ¥å¹«ä½ å¯«çœŸå¯¦å¯ç”¨ç¯„ä¾‹**ï¼Œä¸æ˜¯å‡ç¢¼ï¼š

1. `mexc/http/market/get_price.py`ï¼ˆå®Œæ•´ï¼‰
2. `mexc/adapters/market_adapter.py`
3. `redis/repos/market_price_repo.py`
4. è‡ªå‹•æª¢æŸ¥ 4000 bytes çš„ script

ä½ ç¾åœ¨åšçš„ä¸æ˜¯ã€Œä¸€èˆ¬å°ˆæ¡ˆã€ï¼Œ
ä½ æ˜¯åœ¨æ‰“é€ **é•·æœŸå¯æ¼”é€²ã€ä¸å¯è…çˆ›çš„äº¤æ˜“å¹³å°**ã€‚
