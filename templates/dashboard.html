<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QRL Trading Monitor (Read-Only)</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0f172a;
            --card: #111827;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --accent: #6366f1;
            --success: #22c55e;
            --danger: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
        }
        body { margin: 0; font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .layout { max-width: 1150px; margin: 0 auto; padding: 32px 20px 48px; display: flex; flex-direction: column; gap: 16px; }
        header { display: flex; flex-direction: column; gap: 6px; }
        h1 { margin: 0; font-size: 26px; }
        .subtitle { color: var(--muted); font-size: 14px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
        .card h2 { margin: 0; font-size: 16px; color: var(--muted); letter-spacing: 0.3px; }
        .value { font-size: 30px; font-weight: 700; }
        .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .pill { padding: 4px 10px; border-radius: 20px; font-size: 12px; background: rgba(255, 255, 255, 0.06); color: var(--muted); }
        .section-title { margin: 18px 0 6px; font-size: 16px; color: var(--muted); letter-spacing: 0.2px; }
        ul { margin: 0; padding-left: 18px; color: var(--muted); }
        a { color: var(--accent); }
        .status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; background: rgba(255, 255, 255, 0.05); color: var(--muted); font-size: 13px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--success); box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.18); }
        .error { color: var(--danger); }
        .hint { color: var(--muted); font-size: 13px; }
        button { align-self: flex-start; background: var(--accent); color: #fff; border: none; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
        button:active { opacity: 0.85; }
        table { width: 100%; border-collapse: collapse; color: var(--text); }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { color: var(--muted); font-weight: 600; background: rgba(255, 255, 255, 0.02); }
        .table-card { overflow: hidden; }
        .tag { padding: 3px 8px; border-radius: 8px; font-size: 12px; background: rgba(255, 255, 255, 0.06); }
    </style>
</head>
<body>
    <div class="layout">
        <header>
            <div class="status" aria-live="polite">
                <span class="dot" aria-hidden="true"></span>
                <span>只讀儀表板 · 無交易操作</span>
            </div>
            <h1>QRL/USDT Monitoring</h1>
        </header>

        <div class="grid" aria-live="polite">
            <div class="card">
                <h2>QRL 餘額 (現貨)</h2>
                <div class="value" id="qrl-total">--</div>
                <div class="row hint"><span>價值 (USDT)</span><span id="qrl-value">--</span></div>
                <div class="row hint"><span>可用</span><span id="qrl-free">--</span></div>
            </div>
            <div class="card">
                <h2>USDT 餘額 (現貨)</h2>
                <div class="value" id="usdt-total">--</div>
                <div class="row hint"><span>可用</span><span id="usdt-free">--</span></div>
            </div>
            <div class="card">
                <h2>QRL/USDT 價格</h2>
                <div class="value" id="price">--</div>
                <div class="row"><span class="hint">24h 變化</span><span id="change" class="pill">--</span></div>
                <div class="hint" id="updated">--</div>
            </div>
            <div class="card">
                <h2>最佳買賣價</h2>
                <div class="row"><span class="hint">買一</span><span id="best-bid">--</span></div>
                <div class="row"><span class="hint">賣一</span><span id="best-ask">--</span></div>
            </div>
        </div>

        <div class="row" style="gap:12px; flex-wrap: wrap;">
            <button id="refresh-btn" type="button">重新整理</button>
            <span class="hint">每 30 秒自動更新一次；資料來源：MEXC v3 REST 與 WS (公有/私有)。</span>
            <span class="pill" id="ws-status">WS: 未連線</span>
        </div>

        <div class="card table-card" aria-live="polite">
            <h2>交易規則 (Exchange Info)</h2>
            <table aria-label="Exchange info">
                <thead><tr><th>Symbol</th><th>Status</th><th>最小下單量</th><th>最小金額</th></tr></thead>
                <tbody id="info-body"><tr><td colspan="4" class="hint">載入中...</td></tr></tbody>
            </table>
        </div>

        <div class="card table-card" aria-live="polite">
            <h2>委託簿前 5 檔</h2>
            <table aria-label="Order book">
                <thead><tr><th>檔</th><th>買價</th><th>買量</th><th>賣價</th><th>賣量</th></tr></thead>
                <tbody id="depth-body"><tr><td colspan="5" class="hint">載入中...</td></tr></tbody>
            </table>
        </div>

        <div class="card table-card" aria-live="polite">
            <h2>Aggregate Trades (只讀)</h2>
            <table aria-label="Agg trades">
                <thead><tr><th>時間</th><th>方向</th><th>價格</th><th>數量</th></tr></thead>
                <tbody id="agg-body"><tr><td colspan="4" class="hint">載入中...</td></tr></tbody>
            </table>
        </div>

        <div class="card table-card" aria-live="polite">
            <h2>Kline 最近 5 根</h2>
            <table aria-label="Klines">
                <thead><tr><th>時間</th><th>開</th><th>高</th><th>低</th><th>收</th></tr></thead>
                <tbody id="kline-body"><tr><td colspan="5" class="hint">載入中...</td></tr></tbody>
            </table>
        </div>

        <div class="card table-card" aria-live="polite">
            <h2>我的訂單 (只讀)</h2>
            <table aria-label="Open orders">
                <thead><tr><th>時間</th><th>方向</th><th>價格</th><th>數量</th><th>已成交</th><th>狀態</th></tr></thead>
                <tbody id="orders-body"><tr><td colspan="6" class="hint">載入中...</td></tr></tbody>
            </table>
        </div>

        <div class="card table-card" aria-live="polite">
            <h2>我的成交 (只讀)</h2>
            <table aria-label="Trades">
                <thead><tr><th>時間</th><th>方向</th><th>價格</th><th>數量</th><th>金額</th><th>手續費</th></tr></thead>
                <tbody id="trades-body"><tr><td colspan="6" class="hint">載入中...</td></tr></tbody>
            </table>
        </div>

        <div>
            <div class="section-title">MEXC v3 參考</div>
            <ul>
                <li><a href="https://www.mexc.com/api-docs/spot-v3/market-data-endpoints" target="_blank" rel="noopener noreferrer">Market Data Endpoints</a></li>
                <li><a href="https://www.mexc.com/api-docs/spot-v3/spot-account-trade" target="_blank" rel="noopener noreferrer">Spot Account &amp; Trade</a></li>
                <li><a href="https://www.mexc.com/api-docs/spot-v3/subaccount-endpoints" target="_blank" rel="noopener noreferrer">Sub-Account Endpoints</a></li>
                <li><a href="https://github.com/mexcdevelop/mexc-api-sdk" target="_blank" rel="noopener noreferrer">Official SDK</a></li>
            </ul>
            <p class="hint">僅供監控展示，不會在瀏覽器執行下單、轉帳或任何具副作用的操作。</p>
        </div>
    </div>

    <script>
        const setText = (id, text, color) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = text;
            el.style.color = color || "";
        };
        const formatNumber = (num, digits = 4) => Number.isNaN(num) ? "--" : num.toFixed(digits);
        const formatTime = (ts) => {
            if (!ts) return "--";
            const d = new Date(ts);
            return Number.isNaN(d.getTime()) ? "--" : d.toLocaleString('zh-TW');
        };

        async function loadBalances() {
            try {
                const res = await fetch('/account/balance');
                if (res.status === 503) {
                    setText('qrl-total', 'NEED API KEY', 'var(--warning)');
                    setText('usdt-total', 'NEED API KEY', 'var(--warning)');
                    return;
                }
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const balances = data.balances || {};
                const qrl = balances.QRL || { free: '0', locked: '0' };
                const usdt = balances.USDT || { free: '0', locked: '0' };
                const qrlFree = parseFloat(qrl.free ?? '0');
                const qrlLocked = parseFloat(qrl.locked ?? '0');
                const qrlTotal = parseFloat(qrl.total ?? (qrlFree + qrlLocked));
                const qrlValue = parseFloat(qrl.value_usdt ?? '0');
                const usdtFree = parseFloat(usdt.free ?? '0');
                const usdtLocked = parseFloat(usdt.locked ?? '0');
                const usdtTotal = parseFloat(usdt.total ?? (usdtFree + usdtLocked));
                setText('qrl-total', formatNumber(qrlTotal));
                setText('qrl-value', formatNumber(qrlValue, 2));
                setText('qrl-free', formatNumber(qrlFree));
                setText('qrl-locked', formatNumber(qrlLocked));
                setText('usdt-total', formatNumber(usdtTotal, 2));
                setText('usdt-free', formatNumber(usdtFree, 2));
                setText('usdt-locked', formatNumber(usdtLocked, 2));
            } catch (err) {
                setText('qrl-total', 'ERROR', 'var(--danger)');
                setText('usdt-total', 'ERROR', 'var(--danger)');
                console.error('Balance load failed', err);
            }
        }

        async function loadPrice() {
            try {
                const res = await fetch('/market/ticker/QRLUSDT');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const ticker = data.data || {};
                const price = parseFloat(ticker.lastPrice || ticker.price || '0');
                const change = parseFloat(ticker.priceChangePercent || '0');
                setText('price', formatNumber(price, 6));
                setText('change', `${formatNumber(change, 2)}%`, change >= 0 ? 'var(--success)' : 'var(--danger)');
                setText('updated', new Date().toLocaleString('zh-TW'));
            } catch (err) {
                setText('price', 'ERROR', 'var(--danger)');
                setText('change', '--');
                setText('updated', '');
                console.error('Price load failed', err);
            }
        }

        // --- WebSocket realtime (public) ---
        const WS_BASE = "wss://wbs-api.mexc.com/ws";
        const WS_CHANNELS = [
            "spot@public.aggre.bookTicker.v3.api.pb@100ms@QRLUSDT",
            "spot@public.aggre.deals.v3.api.pb@100ms@QRLUSDT",
            "spot@public.kline.v3.api.pb@QRLUSDT@Min1"
        ];
        let ws;
        function setWsStatus(text, ok=false) {
            const el = document.getElementById("ws-status");
            if (!el) return;
            el.textContent = text;
            el.style.background = ok ? "rgba(34,197,94,0.12)" : "rgba(239,68,68,0.12)";
            el.style.color = ok ? "var(--success)" : "var(--danger)";
        }
        function parseProtoLike(data) {
            if (typeof data === "string") {
                try { return JSON.parse(data); } catch { return null; }
            }
            if (data instanceof ArrayBuffer) {
                try {
                    const text = new TextDecoder().decode(data);
                    return JSON.parse(text);
                } catch { return null; }
            }
            return null;
        }
        function handleWsMessage(msg) {
            if (!msg || typeof msg !== "object") return;
            if (msg.publicbookticker) {
                const t = msg.publicbookticker;
                setText("best-bid", `${t.bidprice || "--"} / ${t.bidquantity || "--"}`);
                setText("best-ask", `${t.askprice || "--"} / ${t.askquantity || "--"}`);
            }
            if (msg.publicdeals && Array.isArray(msg.publicdeals.dealsList)) {
                const [first] = msg.publicdeals.dealsList;
                if (first) {
                    const tbody = document.getElementById("agg-body");
                    if (tbody) {
                        tbody.innerHTML = `<tr><td>${formatTime(first.time)}</td><td>${first.tradetype || "--"}</td><td>${first.price}</td><td>${first.quantity}</td></tr>`;
                    }
                }
            }
        }
        function startWebsocket() {
            if (ws) ws.close();
            ws = new WebSocket(WS_BASE);
            ws.binaryType = "arraybuffer";
            ws.onopen = () => {
                setWsStatus("WS: 已連線", true);
                ws.send(JSON.stringify({ method: "SUBSCRIPTION", params: WS_CHANNELS }));
            };
            ws.onmessage = (ev) => {
                const parsed = parseProtoLike(ev.data);
                if (parsed && parsed.method === "PING") {
                    ws.send(JSON.stringify({ method: "PONG" }));
                    return;
                }
                handleWsMessage(parsed);
            };
            ws.onclose = () => {
                setWsStatus("WS: 連線中斷");
                setTimeout(startWebsocket, 5000);
            };
            ws.onerror = () => setWsStatus("WS: 錯誤");
        }

        async function loadBookTicker() {
            try {
                const res = await fetch('/market/book-ticker/QRLUSDT');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const book = data.data || {};
                setText('best-bid', `${book.bidPrice || '--'} / ${book.bidQty || '--'}`);
                setText('best-ask', `${book.askPrice || '--'} / ${book.askQty || '--'}`);
            } catch (err) {
                setText('best-bid', 'ERROR', 'var(--danger)');
                setText('best-ask', 'ERROR', 'var(--danger)');
                console.error('Book ticker failed', err);
            }
        }

        async function loadExchangeInfo() {
            const body = document.getElementById('info-body');
            try {
                const res = await fetch('/market/exchange-info?symbol=QRLUSDT');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const info = data.data || {};
                const symbols = info.symbols || [];
                if (!symbols.length) {
                    body.innerHTML = '<tr><td colspan="4" class="hint">無資料</td></tr>';
                    return;
                }
                const s = symbols[0];
                const lot = s?.filters?.find?.(f => f.filterType === 'LOT_SIZE');
                const minQty = lot?.minQty || '--';
                const notional = s?.filters?.find?.(f => f.filterType === 'NOTIONAL');
                const minNotional = notional?.minNotional || '--';
                body.innerHTML = `<tr><td>${s.symbol}</td><td>${s.status || '--'}</td><td>${minQty}</td><td>${minNotional}</td></tr>`;
            } catch (err) {
                body.innerHTML = '<tr><td colspan="4" class="error">載入失敗</td></tr>';
                console.error('Exchange info failed', err);
            }
        }

        async function loadDepth() {
            const body = document.getElementById('depth-body');
            try {
                const res = await fetch('/market/orderbook/QRLUSDT?limit=10');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const bids = data.data?.bids || [];
                const asks = data.data?.asks || [];
                const rows = [];
                for (let i = 0; i < 5; i++) {
                    const b = bids[i] || [];
                    const a = asks[i] || [];
                    rows.push(`<tr><td>${i+1}</td><td>${b[0] || '--'}</td><td>${b[1] || '--'}</td><td>${a[0] || '--'}</td><td>${a[1] || '--'}</td></tr>`);
                }
                body.innerHTML = rows.join('');
            } catch (err) {
                body.innerHTML = '<tr><td colspan="5" class="error">深度載入失敗</td></tr>';
                console.error('Depth failed', err);
            }
        }

        async function loadAggTrades() {
            const body = document.getElementById('agg-body');
            try {
                const res = await fetch('/market/agg-trades/QRLUSDT?limit=10');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const trades = data.data || [];
                if (!trades.length) {
                    body.innerHTML = '<tr><td colspan="4" class="hint">無成交</td></tr>';
                    return;
                }
                body.innerHTML = trades.slice(0, 10).map(t => {
                    const side = t.isBuyerMaker ? 'SELL' : 'BUY';
                    return `<tr><td>${formatTime(t.T || t.time)}</td><td><span class="tag">${side}</span></td><td>${t.p || '--'}</td><td>${t.q || '--'}</td></tr>`;
                }).join('');
            } catch (err) {
                body.innerHTML = '<tr><td colspan="4" class="error">Agg trades 載入失敗</td></tr>';
                console.error('Agg trades failed', err);
            }
        }

        async function loadKlines() {
            const body = document.getElementById('kline-body');
            try {
                const res = await fetch('/market/klines/QRLUSDT?interval=1m&limit=5');
                if (res.status === 404) {
                    body.innerHTML = '<tr><td colspan="5" class="hint">僅支援 QRLUSDT</td></tr>';
                    return;
                }
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const klines = data.data || [];
                if (!klines.length) {
                    body.innerHTML = '<tr><td colspan="5" class="hint">無K線資料</td></tr>';
                    return;
                }
                body.innerHTML = klines.slice(-5).map(k => {
                    return `<tr><td>${formatTime(k[0])}</td><td>${k[1]}</td><td>${k[2]}</td><td>${k[3]}</td><td>${k[4]}</td></tr>`;
                }).join('');
            } catch (err) {
                body.innerHTML = '<tr><td colspan="5" class="hint">無K線資料</td></tr>';
                console.error('Klines failed', err);
            }
        }

        async function loadOrders() {
            const body = document.getElementById('orders-body');
            try {
                const res = await fetch('/account/orders');
                if (res.status === 503) {
                    body.innerHTML = '<tr><td colspan="6" class="hint">需要 API key 才能讀取</td></tr>';
                    return;
                }
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const orders = data.orders || [];
                if (!orders.length) {
                    body.innerHTML = '<tr><td colspan="6" class="hint">目前沒有訂單</td></tr>';
                    return;
                }
                body.innerHTML = orders.map(o => {
                    const side = (o.side || '').toUpperCase();
                    const ts = o.time || o.updateTime || o.transactTime;
                    return `<tr><td>${formatTime(ts)}</td><td><span class="tag">${side || '--'}</span></td><td>${o.price || '--'}</td><td>${o.origQty || '--'}</td><td>${o.executedQty || '--'}</td><td>${o.status || '--'}</td></tr>`;
                }).join('');
            } catch (err) {
                body.innerHTML = `<tr><td colspan="6" class="error">訂單載入失敗</td></tr>`;
                console.error('Orders load failed', err);
            }
        }

        async function loadTrades() {
            const body = document.getElementById('trades-body');
            try {
                const res = await fetch('/account/trades');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const trades = data.trades || [];
                if (!trades.length) {
                    body.innerHTML = '<tr><td colspan="6" class="hint">目前沒有成交</td></tr>';
                    return;
                }
                body.innerHTML = trades.map(t => {
                    const isBuyer = t.isBuyer || t.isBuyerMaker;
                    const side = isBuyer ? 'BUY' : 'SELL';
                    const amount = t.quoteQty || (t.price && t.qty ? (parseFloat(t.price) * parseFloat(t.qty)).toFixed(4) : '--');
                    return `<tr><td>${formatTime(t.time || t.transactTime)}</td><td><span class="tag">${side}</span></td><td>${t.price || '--'}</td><td>${t.qty || '--'}</td><td>${amount}</td><td>${t.commission || '--'} ${t.commissionAsset || ''}</td></tr>`;
                }).join('');
            } catch (err) {
                body.innerHTML = `<tr><td colspan="6" class="error">成交載入失敗</td></tr>`;
                console.error('Trades load failed', err);
            }
        }

        async function refreshAll() {
            await Promise.all([
                loadBalances(),
                loadPrice(),
                loadBookTicker(),
                loadExchangeInfo(),
                loadDepth(),
                loadAggTrades(),
                loadKlines(),
                loadOrders(),
                loadTrades(),
            ]);
        }

        document.getElementById('refresh-btn').addEventListener('click', refreshAll);
        refreshAll();
        startWebsocket();
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
