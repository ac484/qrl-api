# Rebalance Integration Architecture

## 當前架構

```
┌─────────────────┐
│ Cloud Scheduler │
└────────┬────────┘
         │
         ├─── 每 15 分鐘 ───────────┐
         │                          │
         │                          ▼
         │              ┌──────────────────────┐
         │              │   15-min-job.py      │
         │              │   /tasks/runtime     │
         │              │                      │
         │              │  ❌ 目前只是簡單的  │
         │              │     keepalive        │
         │              └──────────────────────┘
         │
         └─── 每 4 小時（獨立）────┐
                                   │
                                   ▼
                       ┌──────────────────────┐
                       │   rebalance.py       │
                       │   /tasks/rebalance/  │
                       │   symmetric          │
                       │                      │
                       │  ✅ 完整的再平衡邏輯│
                       └──────────────────────┘
```

## 目標架構（推薦方案 C）

```
┌─────────────────┐
│ Cloud Scheduler │
└────────┬────────┘
         │
         └─── 每 15 分鐘 ───────────┐
                                    │
                                    ▼
                        ┌──────────────────────────────┐
                        │   15-min-job.py              │
                        │   /tasks/runtime             │
                        │                              │
                        │  1️⃣ 認證（共享模組）        │
                        │  2️⃣ 更新成本/損益            │
                        │  3️⃣ 執行再平衡               │
                        │                              │
                        └──────────┬───────────────────┘
                                   │
                   ┌───────────────┼───────────────┐
                   │               │               │
                   ▼               ▼               ▼
           ┌──────────┐    ┌─────────────┐  ┌──────────┐
           │ 共享認證 │    │  Balance    │  │ Rebalance│
           │ 模組     │    │  Service    │  │ Service  │
           └──────────┘    └─────────────┘  └──────────┘
                                   │               │
                                   └───────┬───────┘
                                           │
                                           ▼
                                   ┌──────────────┐
                                   │ Redis Client │
                                   │              │
                                   │ - 儲存計劃  │
                                   │ - 快取數據  │
                                   └──────────────┘

┌──────────────────────────────────────────────────────┐
│ 保留 rebalance.py 端點（向後兼容/獨立觸發）         │
│ /tasks/rebalance/symmetric                           │
│ - 使用相同的共享模組                                 │
│ - 可選：作為緊急手動觸發端點                         │
└──────────────────────────────────────────────────────┘
```

## Rebalance 邏輯流程圖

```
                    開始
                     │
                     ▼
            ┌────────────────┐
            │ 獲取帳戶餘額   │
            │ - QRL 餘額     │
            │ - USDT 餘額    │
            │ - 當前價格     │
            └────────┬───────┘
                     │
                     ▼
            ┌────────────────┐
            │ 計算總價值     │
            │ total_value =  │
            │ qrl*price +    │
            │ usdt           │
            └────────┬───────┘
                     │
                     ▼
            ┌────────────────┐
            │ 計算目標價值   │
            │ target = total │
            │ * 50%          │
            └────────┬───────┘
                     │
                     ▼
            ┌────────────────┐
            │ 計算偏差       │
            │ delta =        │
            │ qrl_value -    │
            │ target         │
            └────────┬───────┘
                     │
         ┌───────────┴───────────┐
         │                       │
    price <= 0?            total_value <= 0?
         │                       │
         └───────┬───────────────┘
                 │ 是
                 ▼
          ┌─────────────┐
          │ HOLD        │
          │ 原因：價格  │
          │ 或餘額不足  │
          └─────────────┘
                 │ 否
                 ▼
       ┌──────────────────┐
       │ notional < 5 USDT?│
       │ 或偏差 < 1%?      │
       └────────┬──────────┘
                │ 是
                ▼
         ┌─────────────┐
         │ HOLD        │
         │ 原因：在閾 │
         │ 值範圍內    │
         └─────────────┘
                │ 否
                ▼
         ┌─────────────┐
         │ delta > 0?  │
         │ (QRL 過多)  │
         └──────┬──────┘
                │
       ┌────────┴────────┐
       │ 是              │ 否
       ▼                 ▼
┌─────────────┐   ┌─────────────┐
│ SELL QRL    │   │ BUY QRL     │
│             │   │             │
│ quantity =  │   │ quantity =  │
│ min(需要,   │   │ min(需要,   │
│ 持有量)     │   │ USDT額度)   │
│             │   │             │
│ 確保不超過  │   │ 如果USDT不足│
│ 可用餘額    │   │ → HOLD      │
└─────────────┘   └─────────────┘
       │                 │
       └────────┬────────┘
                │
                ▼
       ┌─────────────────┐
       │ 儲存計劃到 Redis│
       │ set_rebalance_  │
       │ plan()          │
       └─────────────────┘
                │
                ▼
       ┌─────────────────┐
       │ 返回計劃        │
       │ {action, reason,│
       │  quantity, ...} │
       └─────────────────┘
                │
                ▼
               結束
```

## 數據流圖

```
┌──────────────────────────────────────────────────────┐
│                   Cloud Scheduler                    │
│                  每 15 分鐘觸發                      │
└──────────────────┬───────────────────────────────────┘
                   │
                   │ POST /tasks/runtime
                   │ Headers: X-CloudScheduler / OIDC
                   │
                   ▼
┌──────────────────────────────────────────────────────┐
│              15-min-job Handler                      │
│                                                      │
│  1. 認證檢查                                         │
│     └─> require_scheduler_auth()                    │
│                                                      │
│  2. Redis 連接                                       │
│     └─> ensure_redis_connected()                    │
│                                                      │
│  3. 更新成本/損益（新功能）                          │
│     └─> update_cost_and_pnl()                       │
│         └─> 從 Redis 讀取歷史交易                   │
│         └─> 計算平均成本                            │
│         └─> 計算未實現/已實現損益                   │
│         └─> 儲存到 Redis                            │
│                                                      │
│  4. 執行再平衡                                       │
│     └─> RebalanceService.generate_plan()            │
│         │                                            │
│         ├─> BalanceService.get_account_balance()    │
│         │   └─> MEXC API: GET /api/v3/account       │
│         │   └─> 獲取 QRL/USDT 餘額                  │
│         │                                            │
│         ├─> compute_plan()                          │
│         │   ├─> 計算總價值                          │
│         │   ├─> 計算偏差                            │
│         │   ├─> 決定動作（HOLD/BUY/SELL）          │
│         │   └─> 計算交易數量                        │
│         │                                            │
│         └─> _record_plan()                          │
│             └─> redis.set_rebalance_plan(plan)      │
│                                                      │
└──────────────────┬───────────────────────────────────┘
                   │
                   │ 返回結果
                   │
                   ▼
┌──────────────────────────────────────────────────────┐
│              Response (JSON)                         │
│                                                      │
│  {                                                   │
│    "status": "success",                              │
│    "task": "15-min-job",                             │
│    "auth": "OIDC",                                   │
│    "cost_update": {                                  │
│      "avg_cost": 2.35,                               │
│      "unrealized_pnl": 15.50                         │
│    },                                                │
│    "rebalance": {                                    │
│      "action": "SELL",                               │
│      "quantity": 20.0,                               │
│      "notional_usdt": 50.0,                          │
│      "reason": "QRL above target"                    │
│    }                                                 │
│  }                                                   │
└──────────────────────────────────────────────────────┘

                   │
                   │ 同時寫入
                   │
                   ▼
┌──────────────────────────────────────────────────────┐
│                  Redis Storage                       │
│                                                      │
│  Keys:                                               │
│  - bot:QRLUSDT:cost              (成本數據)         │
│  - bot:QRLUSDT:pnl               (損益數據)         │
│  - bot:QRLUSDT:rebalance:plan    (再平衡計劃)       │
│  - bot:QRLUSDT:rebalance:history (歷史記錄)         │
│                                                      │
└──────────────────────────────────────────────────────┘
```

## 共享模組結構

```
src/app/interfaces/tasks/
├── shared/
│   ├── __init__.py
│   └── task_utils.py
│       ├── require_scheduler_auth()
│       │   ├─ 檢查 X-CloudScheduler header
│       │   └─ 檢查 OIDC Authorization header
│       │
│       ├── ensure_redis_connected()
│       │   └─ 確保 Redis 已連接，否則連接
│       │
│       └── handle_task_error()
│           └─ 統一的錯誤處理和日誌記錄
│
├── 15-min-job.py
│   └─ 使用 shared.task_utils
│
├── rebalance.py
│   └─ 使用 shared.task_utils
│
└── router.py
    └─ 註冊所有任務路由
```

## 錯誤處理流程

```
┌─────────────────┐
│ 15-min-job 執行 │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 認證檢查 │
    └────┬────┘
         │ 失敗
         ├─────────> HTTPException(401, "Unauthorized")
         │
         │ 成功
         ▼
    ┌────────────┐
    │ Redis 連接 │
    └────┬───────┘
         │ 失敗
         ├─────────> HTTPException(503, "Redis unavailable")
         │
         │ 成功
         ▼
    ┌──────────────┐
    │ 更新成本/損益│
    └────┬─────────┘
         │ 失敗
         ├─────────> 記錄錯誤，繼續執行（非關鍵）
         │
         │ 成功或跳過
         ▼
    ┌──────────────┐
    │ 執行再平衡   │
    └────┬─────────┘
         │ 失敗
         ├─────────> 記錄錯誤，返回部分結果
         │
         │ 成功
         ▼
    ┌──────────────┐
    │ 返回完整結果 │
    └──────────────┘
```

## 時序圖

```
Cloud Scheduler    15-min-job        BalanceService    RebalanceService    Redis
      │                │                    │                 │              │
      │─POST /tasks────>│                   │                 │              │
      │  /runtime       │                   │                 │              │
      │                 │                   │                 │              │
      │                 │─認證檢查──────────────────────────────────────────>│
      │                 │<─────────────────────────────────────────────────>│
      │                 │                   │                 │              │
      │                 │─更新成本/損益────────────────────────────────────>│
      │                 │<─────────────────────────────────────────────────>│
      │                 │                   │                 │              │
      │                 │─get_account────>  │                 │              │
      │                 │  _balance()       │                 │              │
      │                 │                   │─MEXC API────>   │              │
      │                 │                   │<──餘額數據──    │              │
      │                 │<─────餘額─────   │                 │              │
      │                 │                   │                 │              │
      │                 │─generate_plan()───────────────────>│              │
      │                 │                   │                 │              │
      │                 │                   │                 │─compute_plan()
      │                 │                   │                 │  (純計算)    │
      │                 │                   │                 │              │
      │                 │                   │                 │─record_plan()>│
      │                 │                   │                 │<──OK────────>│
      │                 │<──────────────────────plan──────────│              │
      │                 │                   │                 │              │
      │<─JSON response──│                   │                 │              │
      │  (含成本+再平衡)│                   │                 │              │
```

## 關鍵決策點

### ✅ 為什麼選擇方案 C（共享模組化）？

1. **代碼重用性**
   - 認證邏輯只寫一次，多處使用
   - Redis 連接管理統一處理
   - 未來其他任務也能受益

2. **性能優化**
   - 避免內部 HTTP 調用開銷
   - 單一 Redis 連接，減少開銷
   - 直接函數調用更快

3. **可維護性**
   - 認證邏輯集中在一處，易於更新
   - 清晰的職責分離
   - 更容易追蹤和調試

4. **可測試性**
   - 各模組可獨立測試
   - Mock 依賴更簡單
   - 單元測試覆蓋率更高

### ❌ 為什麼不選其他方案？

**方案 A（HTTP 調用）**
- 增加網路延遲（本地調用 ~1ms vs HTTP ~10-50ms）
- 需要處理內部認證複雜性
- 錯誤處理鏈更長

**方案 B（直接引入，無共享模組）**
- 代碼重複（認證、連接邏輯）
- 未來維護成本高
- 違反 DRY 原則

## 後續優化機會

1. **異步並行執行**
   - 如果成本更新和再平衡互不依賴
   - 可使用 `asyncio.gather()` 並行執行

2. **配置化參數**
   - 將 `target_ratio`、`threshold_pct` 等參數
   - 移至環境變數或 Redis 配置

3. **監控儀表板**
   - 添加 Grafana 儀表板
   - 顯示再平衡歷史和效果

4. **自動執行**
   - 可選：當 action 不是 HOLD 時
   - 自動觸發訂單執行（需額外安全措施）
