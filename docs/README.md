## 🏗️ 系統架構設計

### 1️⃣ **核心組件**

```
┌─────────────────────────────────────────────┐
│           Cloud Scheduler (定時觸發)          │
│         每分鐘/每5分鐘/自定義時間              │
└──────────────────┬──────────────────────────┘
                   │ HTTP POST
                   ↓
┌─────────────────────────────────────────────┐
│           Cloud Run Service                 │
│  ┌─────────────────────────────────────┐   │
│  │   交易機器人主程序                    │   │
│  │  - 接收 Scheduler 觸發                │   │
│  │  - 執行交易邏輯                       │   │
│  │  - 處理訂單                          │   │
│  └─────────────────────────────────────┘   │
└──────────┬──────────────────┬───────────────┘
           │                  │
           ↓                  ↓
┌──────────────────┐   ┌──────────────────┐
│  Redis (Memorystore) │   │  MEXC API v3     │
│  - 交易狀態          │   │  - 市場數據       │
│  - 價格歷史          │   │  - 下單/查詢      │
│  - 持倉信息          │   │  - 餘額查詢       │
└──────────────────┘   └──────────────────┘
           │
           ↓
┌──────────────────────────────────────────────┐
│           Firestore (可選)                    │
│  - 長期交易記錄                               │
│  - 策略配置                                   │
│  - 性能統計                                   │
└──────────────────────────────────────────────┘
```

---

## ⚙️ 定時運行設計

### **方案一: Cloud Scheduler (推薦)**

**優點:**
- GCP 原生服務,免管理
- 精確的 Cron 表達式
- 自動重試機制
- 成本低廉

**配置示例:**
```
觸發頻率選項:
├─ 高頻交易: */1 * * * * (每分鐘)
├─ 中頻交易: */5 * * * * (每5分鐘)
├─ 低頻交易: */15 * * * * (每15分鐘)
└─ 自定義: 0 */4 * * * (每4小時)
```

**工作流程:**
1. Cloud Scheduler 按時間發送 HTTP POST 到 Cloud Run
2. Cloud Run 收到請求後啟動容器
3. 執行交易邏輯 (5-30秒內完成)
4. 返回結果,容器自動縮容到 0

---

### **方案二: Cloud Run Jobs (批次任務)**

**優點:**
- 適合長時間運行的分析任務
- 可以手動觸發
- 更好的日誌管理

**使用場景:**
- 每日策略回測
- 市場數據分析
- 週期性倉位調整

---

## 🔄 交易機器人邏輯流程

### **1. 啟動階段 (0-2秒)**
```
接收觸發 
  ↓
從 Redis 載入狀態
  ↓
驗證 API 連線
```

### **2. 數據採集 (2-5秒)**
```
呼叫 MEXC API
  ↓
取得 QRL/USDT 實時價格
  ↓
取得帳戶餘額
  ↓
取得當前持倉
  ↓
存入 Redis (TTL: 5分鐘)
```

### **3. 策略判斷 (5-8秒)**
```
從 Redis 讀取歷史價格
  ↓
計算技術指標
  ├─ MA (移動平均線)
  ├─ RSI (相對強弱指標)
  ├─ MACD
  └─ 自定義指標
  ↓
生成交易信號
  ├─ BUY (買入)
  ├─ SELL (賣出)
  └─ HOLD (持有)
```

### **4. 風險控制 (8-10秒)**
```
檢查交易條件
  ├─ 餘額是否足夠?
  ├─ 是否超過每日交易次數限制?
  ├─ 倉位是否過重?
  └─ 價格波動是否異常?
  ↓
計算訂單數量
  ├─ 固定金額法
  ├─ 固定比例法
  └─ 凱利公式
```

### **5. 執行交易 (10-15秒)**
```
如果信號 = BUY
  ↓
呼叫 MEXC 下市價單/限價單
  ↓
等待訂單成交
  ↓
更新 Redis 持倉狀態
  ↓
記錄到 Firestore
```

### **6. 清理與回報 (15-20秒)**
```
計算本次盈虧
  ↓
更新統計數據
  ↓
發送通知 (可選)
  ├─ Email
  ├─ Telegram Bot
  └─ LINE Notify
  ↓
返回 HTTP 200 給 Scheduler
```

---

## 💾 Redis 數據結構設計

### **Key 命名規範:**
```
交易狀態:
bot:qrl-usdt:status          → 運行狀態 (running/paused)
bot:qrl-usdt:position        → 當前持倉 JSON

價格數據:
bot:qrl-usdt:price:latest    → 最新價格
bot:qrl-usdt:price:history   → 價格歷史 (List, 最多100條)

技術指標:
bot:qrl-usdt:indicators:ma   → 移動平均線
bot:qrl-usdt:indicators:rsi  → RSI 值

交易記錄 (短期):
bot:qrl-usdt:trades:today    → 今日交易次數 (TTL: 24h)
bot:qrl-usdt:last-trade      → 最後交易時間戳
```

### **數據過期策略:**
- 價格數據: 5分鐘 TTL
- 交易狀態: 永久保存
- 今日統計: 24小時 TTL

---

## 🎯 交易策略示例

### **策略1: 簡單移動平均線交叉**
```
條件:
├─ 短期MA(5) 上穿 長期MA(20) → 買入信號
├─ 短期MA(5) 下穿 長期MA(20) → 賣出信號
└─ 其他情況 → 持有

風控:
├─ 單筆最大投入: 帳戶餘額的 10%
├─ 止損: -3%
└─ 止盈: +5%
```

### **策略2: RSI 超買超賣**
```
條件:
├─ RSI < 30 且價格下跌 → 買入信號
├─ RSI > 70 且價格上漲 → 賣出信號
└─ 30 ≤ RSI ≤ 70 → 持有

風控:
├─ 每日最多交易 5 次
├─ 連續虧損 3 次暫停交易
└─ 單日最大虧損 5%
```

---

## 📊 監控與告警

### **需要監控的指標:**
1. **系統健康:**
   - Cloud Run 啟動成功率
   - API 響應時間
   - Redis 連線狀態

2. **交易性能:**
   - 今日盈虧
   - 勝率
   - 交易次數

3. **風險指標:**
   - 當前倉位
   - 最大回撤
   - 餘額警報

### **告警觸發條件:**
- API 連續失敗 3 次
- 單日虧損超過 5%
- Redis 連線中斷
- 餘額低於最低門檻

---

## 💰 成本估算 (每月)

| 服務 | 用量 | 費用 (USD) |
|------|------|-----------|
| Cloud Run | 每分鐘觸發,每次20秒 | $5-10 |
| Redis (Memorystore) | 1GB Basic | $30-40 |
| Cloud Scheduler | 每分鐘觸發 | $0.1 |
| Firestore | 1GB 存儲 + 讀寫 | $1-3 |
| **總計** | | **$36-53** |

---

## 🚀 部署步驟概要

### **Phase 1: 基礎設施**
1. 建立 GCP 專案
2. 啟用 Cloud Run、Cloud Scheduler、Memorystore
3. 建立 Redis 實例
4. 設定 VPC 連線 (Cloud Run 連 Redis)

### **Phase 2: 機器人開發**
1. 建立 Docker 容器映像
2. 整合 MEXC API
3. 實作交易策略
4. 加入 Redis 數據存取層

### **Phase 3: 定時任務**
1. 建立 Cloud Scheduler 作業
2. 設定觸發頻率
3. 配置重試策略

### **Phase 4: 測試與監控**
1. 紙上交易測試 (Testnet)
2. 小額實盤測試
3. 設定 Cloud Logging 告警

---

## ⚠️ 重要注意事項

1. **安全性:**
   - MEXC API Key 存放在 Secret Manager
   - Cloud Run 使用服務帳戶,最小權限原則
   - Redis 需要密碼保護

2. **冪等性:**
   - 每次觸發檢查是否已執行
   - 使用 Redis 的 SETNX 防止重複交易

3. **錯誤處理:**
   - API 失敗時不要盲目重試
   - 網路異常時暫停交易
   - 記錄所有錯誤到 Firestore

4. **合規性:**
   - 遵守 MEXC 的 API 速率限制
   - 注意當地加密貨幣交易法規

---
